<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>roboticstoolbox.robot.Robot &mdash; Robotics Toolbox for Python  documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Robotics Toolbox for Python
              <img src="../../../_static/RobToolBox_RoundLogoB.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../arm.html">Robot Arms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mobile.html">Mobile robots</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../blocks.html">bdsim blocks</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Robotics Toolbox for Python</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">roboticstoolbox.robot.Robot</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for roboticstoolbox.robot.Robot</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">@author: Jesse Haviland</span>
<span class="sd">@author: Peter Corke</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># import sys</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">splitext</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">PurePosixPath</span><span class="p">,</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">TypeVar</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">overload</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">Literal</span> <span class="k">as</span> <span class="n">L</span>


<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">spatialmath.base</span> <span class="k">as</span> <span class="nn">smb</span>
<span class="kn">from</span> <span class="nn">spatialmath.base.argcheck</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">getvector</span><span class="p">,</span>
    <span class="n">getmatrix</span><span class="p">,</span>
    <span class="n">verifymatrix</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">spatialgeometry</span> <span class="kn">import</span> <span class="n">Shape</span><span class="p">,</span> <span class="n">CollisionShape</span><span class="p">,</span> <span class="n">Cylinder</span>

<span class="kn">from</span> <span class="nn">spatialmath</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">SE3</span><span class="p">,</span>
    <span class="n">SE2</span><span class="p">,</span>
    <span class="n">SpatialAcceleration</span><span class="p">,</span>
    <span class="n">SpatialVelocity</span><span class="p">,</span>
    <span class="n">SpatialInertia</span><span class="p">,</span>
    <span class="n">SpatialForce</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">roboticstoolbox</span> <span class="k">as</span> <span class="nn">rtb</span>
<span class="kn">from</span> <span class="nn">roboticstoolbox.robot.BaseRobot</span> <span class="kn">import</span> <span class="n">BaseRobot</span>
<span class="kn">from</span> <span class="nn">roboticstoolbox.robot.RobotKinematics</span> <span class="kn">import</span> <span class="n">RobotKinematicsMixin</span>
<span class="kn">from</span> <span class="nn">roboticstoolbox.robot.Gripper</span> <span class="kn">import</span> <span class="n">Gripper</span>
<span class="kn">from</span> <span class="nn">roboticstoolbox.robot.Link</span> <span class="kn">import</span> <span class="n">BaseLink</span><span class="p">,</span> <span class="n">Link</span><span class="p">,</span> <span class="n">Link2</span>
<span class="kn">from</span> <span class="nn">roboticstoolbox.robot.ETS</span> <span class="kn">import</span> <span class="n">ETS</span><span class="p">,</span> <span class="n">ETS2</span>
<span class="kn">from</span> <span class="nn">roboticstoolbox.tools</span> <span class="kn">import</span> <span class="n">xacro</span>
<span class="kn">from</span> <span class="nn">roboticstoolbox.tools</span> <span class="kn">import</span> <span class="n">URDF</span>
<span class="kn">from</span> <span class="nn">roboticstoolbox.tools.types</span> <span class="kn">import</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">NDArray</span>
<span class="kn">from</span> <span class="nn">roboticstoolbox.tools.data</span> <span class="kn">import</span> <span class="n">rtb_path_to_datafile</span>

<span class="c1"># A generic type variable representing any subclass of BaseLink</span>
<span class="n">LinkType</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;LinkType&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">BaseLink</span><span class="p">)</span>


<span class="c1"># ==================================================================================== #</span>
<span class="c1"># ================= Robot Class ====================================================== #</span>
<span class="c1"># ==================================================================================== #</span>


<div class="viewcode-block" id="Robot"><a class="viewcode-back" href="../../../arm_superclass.html#roboticstoolbox.robot.Robot.Robot">[docs]</a><span class="k">class</span> <span class="nc">Robot</span><span class="p">(</span><span class="n">BaseRobot</span><span class="p">[</span><span class="n">Link</span><span class="p">],</span> <span class="n">RobotKinematicsMixin</span><span class="p">):</span>
    <span class="n">_color</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">arg</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Link</span><span class="p">],</span> <span class="n">ETS</span><span class="p">,</span> <span class="s2">&quot;Robot&quot;</span><span class="p">],</span>
        <span class="n">gripper_links</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Link</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Link</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">manufacturer</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">comment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">base</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">SE3</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tool</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">SE3</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">gravity</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.81</span><span class="p">],</span>
        <span class="n">keywords</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="n">symbolic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">configs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">check_jindex</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">urdf_string</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">urdf_filepath</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="n">PurePosixPath</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># Process links</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Robot</span><span class="p">):</span>
            <span class="c1"># We&#39;re passed a Robot, clone it</span>
            <span class="c1"># We need to preserve the parent link as we copy</span>

            <span class="c1"># Copy each link within the robot</span>
            <span class="n">links</span> <span class="o">=</span> <span class="p">[</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">link</span><span class="p">)</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">arg</span><span class="o">.</span><span class="n">links</span><span class="p">]</span>
            <span class="n">gripper_links</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">gripper</span> <span class="ow">in</span> <span class="n">arg</span><span class="o">.</span><span class="n">grippers</span><span class="p">:</span>
                <span class="n">glinks</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">gripper</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
                    <span class="n">glinks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>

                <span class="n">gripper_links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">glinks</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">links</span> <span class="o">=</span> <span class="n">links</span> <span class="o">+</span> <span class="n">glinks</span>

            <span class="c1"># Sever parent connection, but save the string</span>
            <span class="c1"># The constructor will piece this together for us</span>
            <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
                <span class="n">link</span><span class="o">.</span><span class="n">_children</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">link</span><span class="o">.</span><span class="n">_parent_name</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span>
                    <span class="n">link</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">gripper_links</span><span class="o">=</span><span class="n">gripper_links</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">gripper</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grippers</span><span class="p">):</span>
                <span class="n">gripper</span><span class="o">.</span><span class="n">tool</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">grippers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tool</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_urdf_string</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">urdf_string</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_urdf_filepath</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">urdf_filepath</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">ETS</span><span class="p">):</span>
                <span class="c1"># We&#39;re passed an ETS string</span>
                <span class="n">links</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># chop it up into segments, a link frame after every joint</span>
                <span class="n">parent</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ets_j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">split</span><span class="p">()):</span>
                    <span class="n">elink</span> <span class="o">=</span> <span class="n">Link</span><span class="p">(</span><span class="n">ETS</span><span class="p">(</span><span class="n">ets_j</span><span class="p">),</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;link</span><span class="si">{</span><span class="n">j</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">elink</span><span class="o">.</span><span class="n">qlim</span> <span class="ow">is</span> <span class="kc">None</span>
                        <span class="ow">and</span> <span class="n">elink</span><span class="o">.</span><span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="ow">and</span> <span class="n">elink</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">qlim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="p">):</span>
                        <span class="n">elink</span><span class="o">.</span><span class="n">qlim</span> <span class="o">=</span> <span class="n">elink</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">qlim</span>  <span class="c1"># pragma nocover</span>
                    <span class="n">parent</span> <span class="o">=</span> <span class="n">elink</span>
                    <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elink</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">smb</span><span class="o">.</span><span class="n">islistof</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Link</span><span class="p">):</span>
                <span class="n">links</span> <span class="o">=</span> <span class="n">arg</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;arg was invalid, must be List[Link], ETS, or Robot&quot;</span><span class="p">)</span>

            <span class="c1"># Initialise Base Robot object</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
                <span class="n">links</span><span class="o">=</span><span class="n">links</span><span class="p">,</span>
                <span class="n">gripper_links</span><span class="o">=</span><span class="n">gripper_links</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">manufacturer</span><span class="o">=</span><span class="n">manufacturer</span><span class="p">,</span>
                <span class="n">comment</span><span class="o">=</span><span class="n">comment</span><span class="p">,</span>
                <span class="n">base</span><span class="o">=</span><span class="n">base</span><span class="p">,</span>
                <span class="n">tool</span><span class="o">=</span><span class="n">tool</span><span class="p">,</span>
                <span class="n">gravity</span><span class="o">=</span><span class="n">gravity</span><span class="p">,</span>
                <span class="n">keywords</span><span class="o">=</span><span class="n">keywords</span><span class="p">,</span>
                <span class="n">symbolic</span><span class="o">=</span><span class="n">symbolic</span><span class="p">,</span>
                <span class="n">configs</span><span class="o">=</span><span class="n">configs</span><span class="p">,</span>
                <span class="n">check_jindex</span><span class="o">=</span><span class="n">check_jindex</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># --------------------------------------------------------------------- #</span>
    <span class="c1"># --------- Swift Methods --------------------------------------------- #</span>
    <span class="c1"># --------------------------------------------------------------------- #</span>

    <span class="k">def</span> <span class="nf">_to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot_alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">collision_alpha</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="n">ob</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">robot_alpha</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">gi</span> <span class="ow">in</span> <span class="n">link</span><span class="o">.</span><span class="n">geometry</span><span class="p">:</span>
                    <span class="n">gi</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="n">robot_alpha</span><span class="p">)</span>
                    <span class="n">ob</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gi</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">collision_alpha</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">gi</span> <span class="ow">in</span> <span class="n">link</span><span class="o">.</span><span class="n">collision</span><span class="p">:</span>
                    <span class="n">gi</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="n">collision_alpha</span><span class="p">)</span>
                    <span class="n">ob</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gi</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>

        <span class="c1"># Do the grippers now</span>
        <span class="k">for</span> <span class="n">gripper</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grippers</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">gripper</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">robot_alpha</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">gi</span> <span class="ow">in</span> <span class="n">link</span><span class="o">.</span><span class="n">geometry</span><span class="p">:</span>
                        <span class="n">gi</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="n">robot_alpha</span><span class="p">)</span>
                        <span class="n">ob</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gi</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">collision_alpha</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">gi</span> <span class="ow">in</span> <span class="n">link</span><span class="o">.</span><span class="n">collision</span><span class="p">:</span>
                        <span class="n">gi</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="n">collision_alpha</span><span class="p">)</span>
                        <span class="n">ob</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gi</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>

        <span class="c1"># for o in ob:</span>
        <span class="c1">#     print(o)</span>

        <span class="k">return</span> <span class="n">ob</span>

    <span class="k">def</span> <span class="nf">_fk_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot_alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">collision_alpha</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="n">ob</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Do the robot</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">robot_alpha</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">gi</span> <span class="ow">in</span> <span class="n">link</span><span class="o">.</span><span class="n">geometry</span><span class="p">:</span>
                    <span class="n">ob</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gi</span><span class="o">.</span><span class="n">fk_dict</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">collision_alpha</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">gi</span> <span class="ow">in</span> <span class="n">link</span><span class="o">.</span><span class="n">collision</span><span class="p">:</span>
                    <span class="n">ob</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gi</span><span class="o">.</span><span class="n">fk_dict</span><span class="p">())</span>

        <span class="c1"># Do the grippers now</span>
        <span class="k">for</span> <span class="n">gripper</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grippers</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">gripper</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">robot_alpha</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">gi</span> <span class="ow">in</span> <span class="n">link</span><span class="o">.</span><span class="n">geometry</span><span class="p">:</span>
                        <span class="n">ob</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gi</span><span class="o">.</span><span class="n">fk_dict</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">collision_alpha</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">gi</span> <span class="ow">in</span> <span class="n">link</span><span class="o">.</span><span class="n">collision</span><span class="p">:</span>
                        <span class="n">ob</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gi</span><span class="o">.</span><span class="n">fk_dict</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">ob</span>

    <span class="c1"># --------------------------------------------------------------------- #</span>
    <span class="c1"># --------- URDF Methods ---------------------------------------------- #</span>
    <span class="c1"># --------------------------------------------------------------------- #</span>

<div class="viewcode-block" id="Robot.URDF_read"><a class="viewcode-back" href="../../../arm_superclass.html#roboticstoolbox.robot.Robot.Robot.URDF_read">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">URDF_read</span><span class="p">(</span>
        <span class="n">file_path</span><span class="p">,</span> <span class="n">tld</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xacro_tld</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Link</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="n">PurePosixPath</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read a URDF file as Links</span>

<span class="sd">        File should be specified relative to ``RTBDATA/URDF/xacro``</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_path</span>
<span class="sd">            File path relative to the xacro folder</span>
<span class="sd">        tld</span>
<span class="sd">            A custom top-level directory which holds the xacro data,</span>
<span class="sd">            defaults to None</span>
<span class="sd">        xacro_tld</span>
<span class="sd">            A custom top-level within the xacro data,</span>
<span class="sd">            defaults to None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        links</span>
<span class="sd">            a list of links</span>
<span class="sd">        name</span>
<span class="sd">            the name of the robot</span>
<span class="sd">        urdf</span>
<span class="sd">            a string representing the URDF</span>
<span class="sd">        file_path</span>
<span class="sd">            a path to the original file</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        If ``tld`` is not supplied, filepath pointing to xacro data should</span>
<span class="sd">        be directly under ``RTBDATA/URDF/xacro`` OR under ``./xacro`` relative</span>
<span class="sd">        to the model file calling this method. If ``tld`` is supplied, then</span>
<span class="sd">        ```file_path``` needs to be relative to ``tld``</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get the path to the class that defines the robot</span>
        <span class="k">if</span> <span class="n">tld</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">base_path</span> <span class="o">=</span> <span class="n">rtb_path_to_datafile</span><span class="p">(</span><span class="s2">&quot;xacro&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base_path</span> <span class="o">=</span> <span class="n">PurePosixPath</span><span class="p">(</span><span class="n">tld</span><span class="p">)</span>

        <span class="c1"># Add on relative path to get to the URDF or xacro file</span>
        <span class="c1"># base_path = PurePath(classpath).parent.parent / &#39;URDF&#39; / &#39;xacro&#39;</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">base_path</span> <span class="o">/</span> <span class="n">PurePosixPath</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">splitext</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;.xacro&quot;</span><span class="p">:</span>
            <span class="c1"># it&#39;s a xacro file, preprocess it</span>
            <span class="k">if</span> <span class="n">xacro_tld</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">xacro_tld</span> <span class="o">=</span> <span class="n">base_path</span> <span class="o">/</span> <span class="n">PurePosixPath</span><span class="p">(</span><span class="n">xacro_tld</span><span class="p">)</span>
            <span class="n">urdf_string</span> <span class="o">=</span> <span class="n">xacro</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">xacro_tld</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">urdf</span> <span class="o">=</span> <span class="n">URDF</span><span class="o">.</span><span class="n">loadstr</span><span class="p">(</span><span class="n">urdf_string</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">base_path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># pragma nocover</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;error parsing URDF file&quot;</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">e</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma nocover</span>
            <span class="n">urdf_string</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">urdf</span> <span class="o">=</span> <span class="n">URDF</span><span class="o">.</span><span class="n">loadstr</span><span class="p">(</span><span class="n">urdf_string</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">base_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">urdf_string</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>  <span class="c1"># pragma nocover</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Parsing failed, did not get valid URDF string back&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">urdf</span><span class="o">.</span><span class="n">elinks</span><span class="p">,</span> <span class="n">urdf</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">urdf_string</span><span class="p">,</span> <span class="n">file_path</span></div>

<div class="viewcode-block" id="Robot.URDF"><a class="viewcode-back" href="../../../arm_superclass.html#roboticstoolbox.robot.Robot.Robot.URDF">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">URDF</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">gripper</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a Robot object from URDF file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_path</span>
<span class="sd">            the path to the URDF</span>
<span class="sd">        gripper</span>
<span class="sd">            index or name of the gripper link(s)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        If ``gripper`` is specified, links from that link outward are removed</span>
<span class="sd">        from the rigid-body tree and folded into a ``Gripper`` object.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">links</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">urdf_string</span><span class="p">,</span> <span class="n">urdf_filepath</span> <span class="o">=</span> <span class="n">Robot</span><span class="o">.</span><span class="n">URDF_read</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

        <span class="n">gripperLink</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Link</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">gripper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gripper</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">gripperLink</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="n">gripper</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gripper</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">gripper</span><span class="p">:</span>
                        <span class="n">gripperLink</span> <span class="o">=</span> <span class="n">link</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma nocover</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no link named </span><span class="si">{</span><span class="n">gripper</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma nocover</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;bad argument passed as gripper&quot;</span><span class="p">)</span>

        <span class="c1"># links, name, urdf_string, urdf_filepath = Robot.URDF_read(file_path)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">links</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">gripper_links</span><span class="o">=</span><span class="n">gripperLink</span><span class="p">,</span>
            <span class="n">urdf_string</span><span class="o">=</span><span class="n">urdf_string</span><span class="p">,</span>
            <span class="n">urdf_filepath</span><span class="o">=</span><span class="n">urdf_filepath</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="c1">#     # --------------------------------------------------------------------- #</span>
    <span class="c1">#     # --------- Utility Methods ------------------------------------------- #</span>
    <span class="c1">#     # --------------------------------------------------------------------- #</span>

    <span class="c1">#     def showgraph(self, display_graph: bool = True, **kwargs) -&gt; Union[None, str]:</span>
    <span class="c1">#         &quot;&quot;&quot;</span>
    <span class="c1">#         Display a link transform graph in browser</span>

    <span class="c1">#         ``robot.showgraph()`` displays a graph of the robot&#39;s link frames</span>
    <span class="c1">#         and the ETS between them.  It uses GraphViz dot.</span>

    <span class="c1">#         The nodes are:</span>
    <span class="c1">#             - Base is shown as a grey square. This is the world frame origin,</span>
    <span class="c1">#               but can be changed using the ``base`` attribute of the robot.</span>
    <span class="c1">#             - Link frames are indicated by circles</span>
    <span class="c1">#             - ETS transforms are indicated by rounded boxes</span>

    <span class="c1">#         The edges are:</span>
    <span class="c1">#             - an arrow if `jtype` is False or the joint is fixed</span>
    <span class="c1">#             - an arrow with a round head if `jtype` is True and the joint is</span>
    <span class="c1">#               revolute</span>
    <span class="c1">#             - an arrow with a box head if `jtype` is True and the joint is</span>
    <span class="c1">#               prismatic</span>

    <span class="c1">#         Edge labels or nodes in blue have a fixed transformation to the</span>
    <span class="c1">#         preceding link.</span>

    <span class="c1">#         Parameters</span>
    <span class="c1">#         ----------</span>
    <span class="c1">#         display_graph</span>
    <span class="c1">#             Open the graph in a browser if True. Otherwise will return the</span>
    <span class="c1">#             file path</span>
    <span class="c1">#         etsbox</span>
    <span class="c1">#             Put the link ETS in a box, otherwise an edge label</span>
    <span class="c1">#         jtype</span>
    <span class="c1">#             Arrowhead to node indicates revolute or prismatic type</span>
    <span class="c1">#         static</span>
    <span class="c1">#             Show static joints in blue and bold</span>

    <span class="c1">#         Examples</span>
    <span class="c1">#         --------</span>
    <span class="c1">#         &gt;&gt;&gt; import roboticstoolbox as rtb</span>
    <span class="c1">#         &gt;&gt;&gt; panda = rtb.models.URDF.Panda()</span>
    <span class="c1">#         &gt;&gt;&gt; panda.showgraph()</span>

    <span class="c1">#         .. image:: ../figs/panda-graph.svg</span>
    <span class="c1">#             :width: 600</span>

    <span class="c1">#         See Also</span>
    <span class="c1">#         --------</span>
    <span class="c1">#         :func:`dotfile`</span>

    <span class="c1">#         &quot;&quot;&quot;</span>

    <span class="c1">#         # Lazy import</span>
    <span class="c1">#         import tempfile</span>
    <span class="c1">#         import subprocess</span>
    <span class="c1">#         import webbrowser</span>

    <span class="c1">#         # create the temporary dotfile</span>
    <span class="c1">#         dotfile = tempfile.TemporaryFile(mode=&quot;w&quot;)</span>
    <span class="c1">#         self.dotfile(dotfile, **kwargs)</span>

    <span class="c1">#         # rewind the dot file, create PDF file in the filesystem, run dot</span>
    <span class="c1">#         dotfile.seek(0)</span>
    <span class="c1">#         pdffile = tempfile.NamedTemporaryFile(suffix=&quot;.pdf&quot;, delete=False)</span>
    <span class="c1">#         subprocess.run(&quot;dot -Tpdf&quot;, shell=True, stdin=dotfile, stdout=pdffile)</span>

    <span class="c1">#         # open the PDF file in browser (hopefully portable), then cleanup</span>
    <span class="c1">#         if display_graph:  # pragma nocover</span>
    <span class="c1">#             webbrowser.open(f&quot;file://{pdffile.name}&quot;)</span>
    <span class="c1">#         else:</span>
    <span class="c1">#             return pdffile.name</span>

    <span class="c1">#     def dotfile(</span>
    <span class="c1">#         self,</span>
    <span class="c1">#         filename: Union[str, IO[str]],</span>
    <span class="c1">#         etsbox: bool = False,</span>
    <span class="c1">#         ets: L[&quot;full&quot;, &quot;brief&quot;] = &quot;full&quot;,</span>
    <span class="c1">#         jtype: bool = False,</span>
    <span class="c1">#         static: bool = True,</span>
    <span class="c1">#     ):</span>
    <span class="c1">#         &quot;&quot;&quot;</span>
    <span class="c1">#         Write a link transform graph as a GraphViz dot file</span>

    <span class="c1">#         The file can be processed using dot:</span>
    <span class="c1">#             % dot -Tpng -o out.png dotfile.dot</span>

    <span class="c1">#         The nodes are:</span>
    <span class="c1">#             - Base is shown as a grey square.  This is the world frame origin,</span>
    <span class="c1">#               but can be changed using the ``base`` attribute of the robot.</span>
    <span class="c1">#             - Link frames are indicated by circles</span>
    <span class="c1">#             - ETS transforms are indicated by rounded boxes</span>

    <span class="c1">#         The edges are:</span>
    <span class="c1">#             - an arrow if `jtype` is False or the joint is fixed</span>
    <span class="c1">#             - an arrow with a round head if `jtype` is True and the joint is</span>
    <span class="c1">#               revolute</span>
    <span class="c1">#             - an arrow with a box head if `jtype` is True and the joint is</span>
    <span class="c1">#               prismatic</span>

    <span class="c1">#         Edge labels or nodes in blue have a fixed transformation to the</span>
    <span class="c1">#         preceding link.</span>

    <span class="c1">#         Note</span>
    <span class="c1">#         ----</span>
    <span class="c1">#         If ``filename`` is a file object then the file will *not*</span>
    <span class="c1">#             be closed after the GraphViz model is written.</span>

    <span class="c1">#         Parameters</span>
    <span class="c1">#         ----------</span>
    <span class="c1">#         file</span>
    <span class="c1">#             Name of file to write to</span>
    <span class="c1">#         etsbox</span>
    <span class="c1">#             Put the link ETS in a box, otherwise an edge label</span>
    <span class="c1">#         ets</span>
    <span class="c1">#             Display the full ets with &quot;full&quot; or a brief version with &quot;brief&quot;</span>
    <span class="c1">#         jtype</span>
    <span class="c1">#             Arrowhead to node indicates revolute or prismatic type</span>
    <span class="c1">#         static</span>
    <span class="c1">#             Show static joints in blue and bold</span>

    <span class="c1">#         See Also</span>
    <span class="c1">#         --------</span>
    <span class="c1">#         :func:`showgraph`</span>

    <span class="c1">#         &quot;&quot;&quot;</span>

    <span class="c1">#         if isinstance(filename, str):</span>
    <span class="c1">#             file = open(filename, &quot;w&quot;)</span>
    <span class="c1">#         else:</span>
    <span class="c1">#             file = filename</span>

    <span class="c1">#         header = r&quot;&quot;&quot;digraph G {</span>
    <span class="c1"># graph [rankdir=LR];</span>
    <span class="c1"># &quot;&quot;&quot;</span>

    <span class="c1">#         def draw_edge(link, etsbox, jtype, static):</span>
    <span class="c1">#             # draw the edge</span>
    <span class="c1">#             if jtype:</span>
    <span class="c1">#                 if link.isprismatic:</span>
    <span class="c1">#                     edge_options = &#39;arrowhead=&quot;box&quot;, arrowtail=&quot;inv&quot;, dir=&quot;both&quot;&#39;</span>
    <span class="c1">#                 elif link.isrevolute:</span>
    <span class="c1">#                     edge_options = &#39;arrowhead=&quot;dot&quot;, arrowtail=&quot;inv&quot;, dir=&quot;both&quot;&#39;</span>
    <span class="c1">#                 else:</span>
    <span class="c1">#                     edge_options = &#39;arrowhead=&quot;normal&quot;&#39;</span>
    <span class="c1">#             else:</span>
    <span class="c1">#                 edge_options = &#39;arrowhead=&quot;normal&quot;&#39;</span>

    <span class="c1">#             if link.parent is None:</span>
    <span class="c1">#                 parent = &quot;BASE&quot;</span>
    <span class="c1">#             else:</span>
    <span class="c1">#                 parent = link.parent.name</span>

    <span class="c1">#             if etsbox:</span>
    <span class="c1">#                 # put the ets fragment in a box</span>
    <span class="c1">#                 if not link.isjoint and static:</span>
    <span class="c1">#                     node_options = &#39;, fontcolor=&quot;blue&quot;&#39;</span>
    <span class="c1">#                 else:</span>
    <span class="c1">#                     node_options = &quot;&quot;</span>

    <span class="c1">#                 try:</span>
    <span class="c1">#                     file.write(</span>
    <span class="c1">#                         &#39;  {}_ets [shape=box, style=rounded, label=&quot;{}&quot;{}];\n&#39;.format(</span>
    <span class="c1">#                             link.name,</span>
    <span class="c1">#                             link.ets.__str__(q=f&quot;q{link.jindex}&quot;),</span>
    <span class="c1">#                             node_options,</span>
    <span class="c1">#                         )</span>
    <span class="c1">#                     )</span>
    <span class="c1">#                 except UnicodeEncodeError:  # pragma nocover</span>
    <span class="c1">#                     file.write(</span>
    <span class="c1">#                         &#39;  {}_ets [shape=box, style=rounded, label=&quot;{}&quot;{}];\n&#39;.format(</span>
    <span class="c1">#                             link.name,</span>
    <span class="c1">#                             link.ets.__str__(q=f&quot;q{link.jindex}&quot;)</span>
    <span class="c1">#                             .encode(&quot;ascii&quot;, &quot;ignore&quot;)</span>
    <span class="c1">#                             .decode(&quot;ascii&quot;),</span>
    <span class="c1">#                             node_options,</span>
    <span class="c1">#                         )</span>
    <span class="c1">#                     )</span>

    <span class="c1">#                 file.write(&quot;  {} -&gt; {}_ets;\n&quot;.format(parent, link.name))</span>
    <span class="c1">#                 file.write(</span>
    <span class="c1">#                     &quot;  {}_ets -&gt; {} [{}];\n&quot;.format(link.name, link.name, edge_options)</span>
    <span class="c1">#                 )</span>
    <span class="c1">#             else:</span>
    <span class="c1">#                 # put the ets fragment as an edge label</span>
    <span class="c1">#                 if not link.isjoint and static:</span>
    <span class="c1">#                     edge_options += &#39;fontcolor=&quot;blue&quot;&#39;</span>
    <span class="c1">#                 if ets == &quot;full&quot;:</span>
    <span class="c1">#                     estr = link.ets.__str__(q=f&quot;q{link.jindex}&quot;)</span>
    <span class="c1">#                 elif ets == &quot;brief&quot;:</span>
    <span class="c1">#                     if link.jindex is None:</span>
    <span class="c1">#                         estr = &quot;&quot;</span>
    <span class="c1">#                     else:</span>
    <span class="c1">#                         estr = f&quot;...q{link.jindex}&quot;</span>
    <span class="c1">#                 else:</span>
    <span class="c1">#                     return</span>
    <span class="c1">#                 try:</span>
    <span class="c1">#                     file.write(</span>
    <span class="c1">#                         &#39;  {} -&gt; {} [label=&quot;{}&quot;, {}];\n&#39;.format(</span>
    <span class="c1">#                             parent,</span>
    <span class="c1">#                             link.name,</span>
    <span class="c1">#                             estr,</span>
    <span class="c1">#                             edge_options,</span>
    <span class="c1">#                         )</span>
    <span class="c1">#                     )</span>
    <span class="c1">#                 except UnicodeEncodeError:  # pragma nocover</span>
    <span class="c1">#                     file.write(</span>
    <span class="c1">#                         &#39;  {} -&gt; {} [label=&quot;{}&quot;, {}];\n&#39;.format(</span>
    <span class="c1">#                             parent,</span>
    <span class="c1">#                             link.name,</span>
    <span class="c1">#                             estr.encode(&quot;ascii&quot;, &quot;ignore&quot;).decode(&quot;ascii&quot;),</span>
    <span class="c1">#                             edge_options,</span>
    <span class="c1">#                         )</span>
    <span class="c1">#                     )</span>

    <span class="c1">#         file.write(header)</span>

    <span class="c1">#         # add the base link</span>
    <span class="c1">#         file.write(&quot;  BASE [shape=square, style=filled, fillcolor=gray]\n&quot;)</span>

    <span class="c1">#         # add the links</span>
    <span class="c1">#         for link in self:</span>
    <span class="c1">#             # draw the link frame node (circle) or ee node (doublecircle)</span>
    <span class="c1">#             if link in self.ee_links:</span>
    <span class="c1">#                 # end-effector</span>
    <span class="c1">#                 node_options = &#39;shape=&quot;doublecircle&quot;, color=&quot;blue&quot;, fontcolor=&quot;blue&quot;&#39;</span>
    <span class="c1">#             else:</span>
    <span class="c1">#                 node_options = &#39;shape=&quot;circle&quot;&#39;</span>

    <span class="c1">#             file.write(&quot;  {} [{}];\n&quot;.format(link.name, node_options))</span>

    <span class="c1">#             draw_edge(link, etsbox, jtype, static)</span>

    <span class="c1">#         for gripper in self.grippers:</span>
    <span class="c1">#             for link in gripper.links:</span>
    <span class="c1">#                 file.write(&quot;  {} [shape=cds];\n&quot;.format(link.name))</span>
    <span class="c1">#                 draw_edge(link, etsbox, jtype, static)</span>

    <span class="c1">#         file.write(&quot;}\n&quot;)</span>

    <span class="c1">#         if isinstance(filename, str):</span>
    <span class="c1">#             file.close()  # noqa</span>

    <span class="c1"># --------------------------------------------------------------------- #</span>
    <span class="c1"># --------- Kinematic Methods ----------------------------------------- #</span>
    <span class="c1"># --------------------------------------------------------------------- #</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">reach</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reach of the robot</span>

<span class="sd">        A conservative estimate of the reach of the robot. It is computed as</span>
<span class="sd">        the sum of the translational ETs that define the link transform.</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        Computed on the first access. If kinematic parameters</span>
<span class="sd">        subsequently change this will not be reflected.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        reach</span>
<span class="sd">            Maximum reach of the robot</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - Probably an overestimate of reach</span>
<span class="sd">        - Used by numerical inverse kinematics to scale translational</span>
<span class="sd">          error.</span>
<span class="sd">        - For a prismatic joint, uses ``qlim`` if it is set</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># TODO</span>
        <span class="c1"># This should be a start, end method and compute the reach based on the</span>
        <span class="c1"># given ets. Then use an lru_cache to speed up return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reach</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">d_all</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ee_links</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">et</span> <span class="ow">in</span> <span class="n">link</span><span class="o">.</span><span class="n">ets</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">et</span><span class="o">.</span><span class="n">istranslation</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">et</span><span class="o">.</span><span class="n">isjoint</span><span class="p">:</span>
                                <span class="c1"># the length of a prismatic joint depends on the</span>
                                <span class="c1"># joint limits.  They might be set in the ET</span>
                                <span class="c1"># or in the Link depending on how the robot</span>
                                <span class="c1"># was constructed</span>
                                <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">qlim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">d</span> <span class="o">+=</span> <span class="nb">max</span><span class="p">(</span><span class="n">link</span><span class="o">.</span><span class="n">qlim</span><span class="p">)</span>
                                <span class="k">elif</span> <span class="n">et</span><span class="o">.</span><span class="n">qlim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma nocover</span>
                                    <span class="n">d</span> <span class="o">+=</span> <span class="nb">max</span><span class="p">(</span><span class="n">et</span><span class="o">.</span><span class="n">qlim</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">d</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">et</span><span class="o">.</span><span class="n">eta</span><span class="p">)</span>
                    <span class="n">link</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">parent</span>
                    <span class="k">if</span> <span class="n">link</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">d_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                        <span class="k">break</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_reach</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">d_all</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reach</span>

<div class="viewcode-block" id="Robot.fkine_all"><a class="viewcode-back" href="../../../arm_superclass.html#roboticstoolbox.robot.Robot.Robot.fkine_all">[docs]</a>    <span class="k">def</span> <span class="nf">fkine_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SE3</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the pose of every link frame</span>

<span class="sd">        ``T = robot.fkine_all(q)`` is  an SE3 instance with ``robot.nlinks +</span>
<span class="sd">        1`` values:</span>

<span class="sd">        - ``T[0]`` is the base transform</span>
<span class="sd">        - ``T[i]`` is the pose of link whose ``number`` is ``i``</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        q</span>
<span class="sd">            The joint configuration</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fkine_all</span>
<span class="sd">            Pose of all links</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        - J. Haviland, and P. Corke. &quot;Manipulator Differential Kinematics Part I:</span>
<span class="sd">          Kinematics, Velocity, and Applications.&quot; arXiv preprint arXiv:2207.01796 (2022).</span>

<span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa</span>

        <span class="n">q</span> <span class="o">=</span> <span class="n">getvector</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>

        <span class="n">Tbase</span> <span class="o">=</span> <span class="n">SE3</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">)</span>  <span class="c1"># add base, also sets the type</span>

        <span class="n">linkframes</span> <span class="o">=</span> <span class="n">Tbase</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">Alloc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nlinks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">linkframes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Tbase</span>

        <span class="k">def</span> <span class="nf">recurse</span><span class="p">(</span><span class="n">Tall</span><span class="p">,</span> <span class="n">Tparent</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">link</span><span class="p">):</span>
            <span class="c1"># if joint??</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">Tparent</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">T</span> <span class="o">*=</span> <span class="n">SE3</span><span class="p">(</span><span class="n">link</span><span class="o">.</span><span class="n">A</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">link</span><span class="o">.</span><span class="n">jindex</span><span class="p">]))</span>

                <span class="n">Tall</span><span class="p">[</span><span class="n">link</span><span class="o">.</span><span class="n">number</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span>

                <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">nchildren</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># no children</span>
                    <span class="k">return</span>
                <span class="k">elif</span> <span class="n">link</span><span class="o">.</span><span class="n">nchildren</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># one child</span>
                    <span class="k">if</span> <span class="n">link</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ee_links</span><span class="p">:</span>  <span class="c1"># pragma nocover</span>
                        <span class="c1"># this link is an end-effector, go no further</span>
                        <span class="k">return</span>
                    <span class="n">link</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># multiple children</span>
                    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">link</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                        <span class="n">recurse</span><span class="p">(</span><span class="n">Tall</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span>
                    <span class="k">return</span>

        <span class="n">recurse</span><span class="p">(</span><span class="n">linkframes</span><span class="p">,</span> <span class="n">Tbase</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">linkframes</span></div>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">manipulability</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">q</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
        <span class="n">J</span><span class="p">:</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">end</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Link</span><span class="p">,</span> <span class="n">Gripper</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Link</span><span class="p">,</span> <span class="n">Gripper</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="n">L</span><span class="p">[</span><span class="s2">&quot;yoshikawa&quot;</span><span class="p">,</span> <span class="s2">&quot;asada&quot;</span><span class="p">,</span> <span class="s2">&quot;minsingular&quot;</span><span class="p">,</span> <span class="s2">&quot;invcondition&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;yoshikawa&quot;</span><span class="p">,</span>
        <span class="n">axes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">L</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;trans&quot;</span><span class="p">,</span> <span class="s2">&quot;rot&quot;</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]:</span>  <span class="c1"># pragma nocover</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">manipulability</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">q</span><span class="p">:</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">J</span><span class="p">:</span> <span class="n">NDArray</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
        <span class="n">end</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Link</span><span class="p">,</span> <span class="n">Gripper</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Link</span><span class="p">,</span> <span class="n">Gripper</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="n">L</span><span class="p">[</span><span class="s2">&quot;yoshikawa&quot;</span><span class="p">,</span> <span class="s2">&quot;asada&quot;</span><span class="p">,</span> <span class="s2">&quot;minsingular&quot;</span><span class="p">,</span> <span class="s2">&quot;invcondition&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;yoshikawa&quot;</span><span class="p">,</span>
        <span class="n">axes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">L</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;trans&quot;</span><span class="p">,</span> <span class="s2">&quot;rot&quot;</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]:</span>  <span class="c1"># pragma nocover</span>
        <span class="o">...</span>

<div class="viewcode-block" id="Robot.manipulability"><a class="viewcode-back" href="../../../arm_superclass.html#roboticstoolbox.robot.Robot.Robot.manipulability">[docs]</a>    <span class="k">def</span> <span class="nf">manipulability</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">q</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">J</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">end</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Link</span><span class="p">,</span> <span class="n">Gripper</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Link</span><span class="p">,</span> <span class="n">Gripper</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="n">L</span><span class="p">[</span><span class="s2">&quot;yoshikawa&quot;</span><span class="p">,</span> <span class="s2">&quot;asada&quot;</span><span class="p">,</span> <span class="s2">&quot;minsingular&quot;</span><span class="p">,</span> <span class="s2">&quot;invcondition&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;yoshikawa&quot;</span><span class="p">,</span>
        <span class="n">axes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">L</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;trans&quot;</span><span class="p">,</span> <span class="s2">&quot;rot&quot;</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Manipulability measure</span>

<span class="sd">        ``manipulability(q)`` is the scalar manipulability index</span>
<span class="sd">        for the robot at the joint configuration ``q``.  It indicates</span>
<span class="sd">        dexterity, that is, how well conditioned the robot is for motion</span>
<span class="sd">        with respect to the 6 degrees of Cartesian motion.  The values is</span>
<span class="sd">        zero if the robot is at a singularity.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        q</span>
<span class="sd">            Joint coordinates, one of J or q required</span>
<span class="sd">        J</span>
<span class="sd">            Jacobian in base frame if already computed, one of J or</span>
<span class="sd">            q required</span>
<span class="sd">        method</span>
<span class="sd">            method to use, &quot;yoshikawa&quot; (default), &quot;invcondition&quot;,</span>
<span class="sd">            &quot;minsingular&quot;  or &quot;asada&quot;</span>
<span class="sd">        axes</span>
<span class="sd">            Task space axes to consider: &quot;all&quot; [default],</span>
<span class="sd">            &quot;trans&quot;, or &quot;rot&quot;</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        manipulability</span>

<span class="sd">        Synopsis</span>
<span class="sd">        --------</span>

<span class="sd">        Various measures are supported:</span>

<span class="sd">        | Measure           |       Description                               |</span>
<span class="sd">        |-------------------|-------------------------------------------------|</span>
<span class="sd">        | ``&quot;yoshikawa&quot;``   | Volume of the velocity ellipsoid, *distance*    |</span>
<span class="sd">        |                   | from singularity [Yoshikawa85]_                 |</span>
<span class="sd">        | ``&quot;invcondition&quot;``| Inverse condition number of Jacobian, isotropy  |</span>
<span class="sd">        |                   | of the velocity ellipsoid [Klein87]_            |</span>
<span class="sd">        | ``&quot;minsingular&quot;`` | Minimum singular value of the Jacobian,         |</span>
<span class="sd">        |                   | *distance*  from singularity [Klein87]_         |</span>
<span class="sd">        | ``&quot;asada&quot;``       | Isotropy of the task-space acceleration         |</span>
<span class="sd">        |                   | ellipsoid which is a function of the Cartesian  |</span>
<span class="sd">        |                   | inertia matrix which depends on the inertial    |</span>
<span class="sd">        |                   | parameters [Asada83]_                           |</span>

<span class="sd">        **Trajectory operation**:</span>

<span class="sd">        If ``q`` is a matrix (m,n) then the result (m,) is a vector of</span>
<span class="sd">        manipulability indices for each joint configuration specified by a row</span>
<span class="sd">        of ``q``.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - Invokes the ``jacob0`` method of the robot if ``J`` is not passed</span>
<span class="sd">        - The &quot;all&quot; option includes rotational and translational</span>
<span class="sd">            dexterity, but this involves adding different units. It can be</span>
<span class="sd">            more useful to look at the translational and rotational</span>
<span class="sd">            manipulability separately.</span>
<span class="sd">        - Examples in the RVC book (1st edition) can be replicated by</span>
<span class="sd">            using the &quot;all&quot; option</span>
<span class="sd">        - Asada&#39;s measure requires inertial a robot model with inertial</span>
<span class="sd">            parameters.</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        .. [Yoshikawa85] Manipulability of Robotic Mechanisms. Yoshikawa T.,</span>
<span class="sd">                The International Journal of Robotics Research.</span>
<span class="sd">                1985;4(2):3-9. doi:10.1177/027836498500400201</span>
<span class="sd">        .. [Asada83] A geometrical representation of manipulator dynamics and</span>
<span class="sd">                its application to arm design, H. Asada,</span>
<span class="sd">                Journal of Dynamic Systems, Measurement, and Control,</span>
<span class="sd">                vol. 105, p. 131, 1983.</span>
<span class="sd">        .. [Klein87] Dexterity Measures for the Design and Control of</span>
<span class="sd">                Kinematically Redundant Manipulators. Klein CA, Blaho BE.</span>
<span class="sd">                The International Journal of Robotics Research.</span>
<span class="sd">                1987;6(2):72-83. doi:10.1177/027836498700600206</span>
<span class="sd">        - Robotics, Vision &amp; Control, Chap 8, P. Corke, Springer 2011.</span>


<span class="sd">        .. versionchanged:: 1.0.3</span>
<span class="sd">            Removed &#39;both&#39; option for axes, added a custom list option.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ets</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>

        <span class="n">axes_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">axes_list</span> <span class="o">=</span> <span class="n">axes</span>
        <span class="k">elif</span> <span class="n">axes</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">axes_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">axes</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;trans&quot;</span><span class="p">):</span>
            <span class="n">axes_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">axes</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;rot&quot;</span><span class="p">):</span>
            <span class="n">axes_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">axes</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">manipulability</span><span class="p">(</span>
                    <span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">,</span> <span class="n">J</span><span class="o">=</span><span class="n">J</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="s2">&quot;trans&quot;</span>
                <span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">manipulability</span><span class="p">(</span>
                    <span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">,</span> <span class="n">J</span><span class="o">=</span><span class="n">J</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="s2">&quot;rot&quot;</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;axes must be all, trans, rot or both&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">yoshikawa</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">axes_list</span><span class="p">):</span>
            <span class="n">J</span> <span class="o">=</span> <span class="n">J</span><span class="p">[</span><span class="n">axes_list</span><span class="p">,</span> <span class="p">:]</span>
            <span class="k">if</span> <span class="n">J</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">J</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="c1"># simplified case for square matrix</span>
                <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">J</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">m2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">J</span> <span class="o">@</span> <span class="n">J</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">m2</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">condition</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">axes_list</span><span class="p">):</span>
            <span class="n">J</span> <span class="o">=</span> <span class="n">J</span><span class="p">[</span><span class="n">axes_list</span><span class="p">,</span> <span class="p">:]</span>

            <span class="c1"># return 1/cond(J)</span>
            <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">J</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">minsingular</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">axes_list</span><span class="p">):</span>
            <span class="n">J</span> <span class="o">=</span> <span class="n">J</span><span class="p">[</span><span class="n">axes_list</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">compute_uv</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># return last/smallest singular value of J</span>
            <span class="k">return</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">asada</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">axes_list</span><span class="p">):</span>
            <span class="c1"># dof = np.sum(axes_list)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">matrix_rank</span><span class="p">(</span><span class="n">J</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="n">Ji</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">J</span><span class="p">)</span>
            <span class="n">Mx</span> <span class="o">=</span> <span class="n">Ji</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">robot</span><span class="o">.</span><span class="n">inertia</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">@</span> <span class="n">Ji</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">axes_list</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">Mx</span> <span class="o">=</span> <span class="n">Mx</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
            <span class="n">Mx</span> <span class="o">=</span> <span class="n">Mx</span><span class="p">[:,</span> <span class="n">d</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
            <span class="n">e</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">Mx</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="c1"># choose the handler function</span>
        <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;yoshi&quot;</span><span class="p">):</span>
            <span class="n">mfunc</span> <span class="o">=</span> <span class="n">yoshikawa</span>
        <span class="k">elif</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;invc&quot;</span><span class="p">):</span>
            <span class="n">mfunc</span> <span class="o">=</span> <span class="n">condition</span>
        <span class="k">elif</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;mins&quot;</span><span class="p">):</span>
            <span class="n">mfunc</span> <span class="o">=</span> <span class="n">minsingular</span>
        <span class="k">elif</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;asa&quot;</span><span class="p">):</span>
            <span class="n">mfunc</span> <span class="o">=</span> <span class="n">asada</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid method chosen&quot;</span><span class="p">)</span>

        <span class="c1"># Calculate manipulability based on supplied Jacobian</span>
        <span class="k">if</span> <span class="n">J</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="p">[</span><span class="n">mfunc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">axes_list</span><span class="p">)]</span>

        <span class="c1"># Otherwise use the q vector/matrix</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">getmatrix</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)))</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">qk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
                <span class="n">Jk</span> <span class="o">=</span> <span class="n">ets</span><span class="o">.</span><span class="n">jacob0</span><span class="p">(</span><span class="n">qk</span><span class="p">)</span>
                <span class="n">w</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">mfunc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Jk</span><span class="p">,</span> <span class="n">qk</span><span class="p">,</span> <span class="n">axes_list</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">w</span></div>

<div class="viewcode-block" id="Robot.jtraj"><a class="viewcode-back" href="../../../arm_superclass.html#roboticstoolbox.robot.Robot.Robot.jtraj">[docs]</a>    <span class="k">def</span> <span class="nf">jtraj</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">T1</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">SE3</span><span class="p">],</span>
        <span class="n">T2</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">SE3</span><span class="p">],</span>
        <span class="n">t</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Joint-space trajectory between SE(3) poses</span>

<span class="sd">        The initial and final poses are mapped to joint space using inverse</span>
<span class="sd">        kinematics:</span>

<span class="sd">        - if the object has an analytic solution ``ikine_a`` that will be used,</span>
<span class="sd">        - otherwise the general numerical algorithm ``ikine_lm`` will be used.</span>

<span class="sd">        ``traj = obot.jtraj(T1, T2, t)`` is a trajectory object whose</span>
<span class="sd">        attribute ``traj.q`` is a row-wise joint-space trajectory.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        T1</span>
<span class="sd">            initial end-effector pose</span>
<span class="sd">        T2</span>
<span class="sd">            final end-effector pose</span>
<span class="sd">        t</span>
<span class="sd">            time vector or number of steps</span>
<span class="sd">        kwargs</span>
<span class="sd">            arguments passed to the IK solver</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        trajectory</span>

<span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;ikine_a&quot;</span><span class="p">):</span>
            <span class="n">ik</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ikine_a</span>  <span class="c1"># type: ignore</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ik</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ikine_LM</span>

        <span class="n">q1</span> <span class="o">=</span> <span class="n">ik</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">q2</span> <span class="o">=</span> <span class="n">ik</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rtb</span><span class="o">.</span><span class="n">jtraj</span><span class="p">(</span><span class="n">q1</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="n">q2</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span></div>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">jacob0_dot</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">q</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
        <span class="n">qd</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
        <span class="n">J0</span><span class="p">:</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">representation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">L</span><span class="p">[</span><span class="s2">&quot;rpy/xyz&quot;</span><span class="p">,</span> <span class="s2">&quot;rpy/zyx&quot;</span><span class="p">,</span> <span class="s2">&quot;eul&quot;</span><span class="p">,</span> <span class="s2">&quot;exp&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>  <span class="c1"># pragma no cover</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">jacob0_dot</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">q</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">qd</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
        <span class="n">J0</span><span class="p">:</span> <span class="n">NDArray</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
        <span class="n">representation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">L</span><span class="p">[</span><span class="s2">&quot;rpy/xyz&quot;</span><span class="p">,</span> <span class="s2">&quot;rpy/zyx&quot;</span><span class="p">,</span> <span class="s2">&quot;eul&quot;</span><span class="p">,</span> <span class="s2">&quot;exp&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>  <span class="c1"># pragma no cover</span>
        <span class="o">...</span>

<div class="viewcode-block" id="Robot.jacob0_dot"><a class="viewcode-back" href="../../../arm_superclass.html#roboticstoolbox.robot.Robot.Robot.jacob0_dot">[docs]</a>    <span class="k">def</span> <span class="nf">jacob0_dot</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">q</span><span class="p">,</span>
        <span class="n">qd</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
        <span class="n">J0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">representation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">L</span><span class="p">[</span><span class="s2">&quot;rpy/xyz&quot;</span><span class="p">,</span> <span class="s2">&quot;rpy/zyx&quot;</span><span class="p">,</span> <span class="s2">&quot;eul&quot;</span><span class="p">,</span> <span class="s2">&quot;exp&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Derivative of Jacobian</span>

<span class="sd">        ``robot.jacob_dot(q, qd)`` computes the rate of change of the</span>
<span class="sd">        Jacobian elements</span>

<span class="sd">        .. math::</span>

<span class="sd">            \dmat{J} = \frac{d \mat{J}}{d \vec{q}} \frac{d \vec{q}}{dt}</span>

<span class="sd">        where the first term is the rank-3 Hessian.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        q</span>
<span class="sd">        The joint configuration of the robot</span>
<span class="sd">        qd</span>
<span class="sd">            The joint velocity of the robot</span>
<span class="sd">        J0</span>
<span class="sd">            Jacobian in {0} frame</span>
<span class="sd">        representation</span>
<span class="sd">            angular representation</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        jdot</span>
<span class="sd">            The derivative of the manipulator Jacobian</span>

<span class="sd">        Synopsis</span>
<span class="sd">        --------</span>

<span class="sd">        If ``J0`` is already calculated for the joint</span>
<span class="sd">        coordinates ``q`` it can be passed in to to save computation time.</span>

<span class="sd">        It is computed as the mode-3 product of the Hessian tensor and the</span>
<span class="sd">        velocity vector.</span>

<span class="sd">        The derivative of an analytical Jacobian can be obtained by setting</span>
<span class="sd">        ``representation`` as</span>

<span class="sd">        |``representation``   |       Rotational representation     |</span>
<span class="sd">        |---------------------|-------------------------------------|</span>
<span class="sd">        |``&#39;rpy/xyz&#39;``        |   RPY angular rates in XYZ order    |</span>
<span class="sd">        |``&#39;rpy/zyx&#39;``        |   RPY angular rates in XYZ order    |</span>
<span class="sd">        |``&#39;eul&#39;``            |   Euler angular rates in ZYZ order  |</span>
<span class="sd">        |``&#39;exp&#39;``            |   exponential coordinate rates      |</span>


<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        - Kinematic Derivatives using the Elementary Transform</span>
<span class="sd">            Sequence, J. Haviland and P. Corke</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :func:`jacob0`</span>
<span class="sd">        :func:`hessian0`</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">qd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">qd</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">representation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">J0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">J0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jacob0</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
            <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hessian0</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">J0</span><span class="o">=</span><span class="n">J0</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># # determine analytic rotation</span>
            <span class="c1"># T = self.fkine(q).A</span>
            <span class="c1"># gamma = smb.r2x(smb.t2r(T), representation=representation)</span>

            <span class="c1"># # get transformation angular velocity to analytic velocity</span>
            <span class="c1"># Ai = smb.rotvelxform(</span>
            <span class="c1">#     gamma, representation=representation, inverse=True, full=True</span>
            <span class="c1"># )</span>

            <span class="c1"># # get analytic rate from joint rates</span>
            <span class="c1"># omega = J0[3:, :] @ qd</span>
            <span class="c1"># gamma_dot = Ai[3:, 3:] @ omega</span>
            <span class="c1"># Ai_dot = smb.rotvelxform_inv_dot(gamma, gamma_dot, full=True)</span>
            <span class="c1"># Ai_dot = sp.linalg.block_diag(np.zeros((3, 3)), Ai_dot)</span>

            <span class="c1"># Jd = Ai_dot @ J0 + Ai @ Jd</span>

            <span class="c1"># not actually sure this can be written in closed form</span>

            <span class="n">H</span> <span class="o">=</span> <span class="n">smb</span><span class="o">.</span><span class="n">numhess</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">q</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">jacob0_analytical</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">representation</span><span class="o">=</span><span class="n">representation</span><span class="p">),</span> <span class="n">q</span>
            <span class="p">)</span>

            <span class="c1"># Jd = Ai @ Jd</span>

            <span class="c1"># return Jd</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">qd</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span></div>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">jacobm</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">q</span><span class="p">:</span> <span class="n">ArrayLike</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
        <span class="n">J</span><span class="p">:</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">H</span><span class="p">:</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">end</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Link</span><span class="p">,</span> <span class="n">Gripper</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Link</span><span class="p">,</span> <span class="n">Gripper</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">axes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">L</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;trans&quot;</span><span class="p">,</span> <span class="s2">&quot;rot&quot;</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>  <span class="c1"># pragma no cover</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">jacobm</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">q</span><span class="p">:</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">J</span><span class="p">:</span> <span class="n">NDArray</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
        <span class="n">H</span><span class="p">:</span> <span class="n">NDArray</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
        <span class="n">end</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Link</span><span class="p">,</span> <span class="n">Gripper</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Link</span><span class="p">,</span> <span class="n">Gripper</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">axes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">L</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;trans&quot;</span><span class="p">,</span> <span class="s2">&quot;rot&quot;</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>  <span class="c1"># pragma no cover</span>
        <span class="o">...</span>

<div class="viewcode-block" id="Robot.jacobm"><a class="viewcode-back" href="../../../arm_superclass.html#roboticstoolbox.robot.Robot.Robot.jacobm">[docs]</a>    <span class="k">def</span> <span class="nf">jacobm</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">q</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">J</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">H</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">end</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Link</span><span class="p">,</span> <span class="n">Gripper</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Link</span><span class="p">,</span> <span class="n">Gripper</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">axes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">L</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;trans&quot;</span><span class="p">,</span> <span class="s2">&quot;rot&quot;</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The manipulability Jacobian</span>

<span class="sd">        This measure relates the rate of change of the manipulability to the</span>
<span class="sd">        joint velocities of the robot. One of J or q is required. Supply J</span>
<span class="sd">        and H if already calculated to save computation time</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        q</span>
<span class="sd">            The joint angles/configuration of the robot (Optional,</span>
<span class="sd">            if not supplied will use the stored q values).</span>
<span class="sd">        J</span>
<span class="sd">            The manipulator Jacobian in any frame</span>
<span class="sd">        H</span>
<span class="sd">            The manipulator Hessian in any frame</span>
<span class="sd">        end</span>
<span class="sd">            the final link or Gripper which the Hessian represents</span>
<span class="sd">        start</span>
<span class="sd">            the first link which the Hessian represents</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        jacobm</span>
<span class="sd">            The manipulability Jacobian</span>

<span class="sd">        Synopsis</span>
<span class="sd">        --------</span>
<span class="sd">        Yoshikawa&#39;s manipulability measure</span>

<span class="sd">        .. math::</span>

<span class="sd">            m(\vec{q}) = \sqrt{\mat{J}(\vec{q}) \mat{J}(\vec{q})^T}</span>

<span class="sd">        This method returns its Jacobian with respect to configuration</span>

<span class="sd">        .. math::</span>

<span class="sd">            \frac{\partial m(\vec{q})}{\partial \vec{q}}</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        - J. Haviland, and P. Corke. &quot;Manipulator Differential Kinematics Part I:</span>
<span class="sd">          Kinematics, Velocity, and Applications.&quot; arXiv preprint arXiv:2207.01796 (2022).</span>
<span class="sd">        - J. Haviland, and P. Corke. &quot;Manipulator Differential Kinematics Part II:</span>
<span class="sd">          Acceleration and Advanced Applications.&quot; arXiv preprint arXiv:2207.01794 (2022).</span>

<span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa</span>

        <span class="n">end</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_limit_links</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">axes</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">):</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">axes</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;trans&quot;</span><span class="p">):</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">axes</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;rot&quot;</span><span class="p">):</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;axes must be all, trans or rot&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">J</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">q</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">q</span> <span class="o">=</span> <span class="n">getvector</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>

            <span class="n">J</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jacob0</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">verifymatrix</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">))</span>

        <span class="n">n</span> <span class="o">=</span> <span class="n">J</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">H</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hessian0</span><span class="p">(</span><span class="n">J0</span><span class="o">=</span><span class="n">J</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">verifymatrix</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">))</span>

        <span class="n">manipulability</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manipulability</span><span class="p">(</span>
            <span class="n">q</span><span class="p">,</span> <span class="n">J</span><span class="o">=</span><span class="n">J</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span>  <span class="c1"># type: ignore</span>
        <span class="p">)</span>

        <span class="n">J</span> <span class="o">=</span> <span class="n">J</span><span class="p">[</span><span class="n">axes</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># type: ignore</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">H</span><span class="p">[:,</span> <span class="n">axes</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># type: ignore</span>

        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">J</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">J</span><span class="p">))</span>
        <span class="n">Jm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">J</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
            <span class="n">Jm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">manipulability</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="s2">&quot;F&quot;</span><span class="p">))</span> <span class="o">@</span> <span class="n">b</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="s2">&quot;F&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Jm</span></div>

    <span class="c1"># --------------------------------------------------------------------- #</span>
    <span class="c1"># --------- Collision Methods ----------------------------------------- #</span>
    <span class="c1"># --------------------------------------------------------------------- #</span>

<div class="viewcode-block" id="Robot.closest_point"><a class="viewcode-back" href="../../../arm_superclass.html#roboticstoolbox.robot.Robot.Robot.closest_point">[docs]</a>    <span class="k">def</span> <span class="nf">closest_point</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="n">Shape</span><span class="p">,</span> <span class="n">inf_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">skip</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">Union</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">Union</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="kc">None</span><span class="p">],]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the closest point between robot and shape</span>

<span class="sd">        ``closest_point(shape, inf_dist)`` returns the minimum euclidean</span>
<span class="sd">        distance between this robot and shape, provided it is less than</span>
<span class="sd">        inf_dist. It will also return the points on self and shape in the</span>
<span class="sd">        world frame which connect the line of length distance between the</span>
<span class="sd">        shapes. If the distance is negative then the shapes are collided.</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        shape</span>
<span class="sd">            The shape to compare distance to</span>
<span class="sd">        inf_dist</span>
<span class="sd">            The minimum distance within which to consider</span>
<span class="sd">            the shape</span>
<span class="sd">        skip</span>
<span class="sd">            Skip setting all shape transforms based on q, use this</span>
<span class="sd">            option if using this method in conjuction with Swift to save time</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        d</span>
<span class="sd">            distance between the robot and shape</span>
<span class="sd">        p1</span>
<span class="sd">            [x, y, z] point on the robot (in the world frame)</span>
<span class="sd">        p2</span>
<span class="sd">            [x, y, z] point on the shape (in the world frame)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_link_tf</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_propogate_scene_tree</span><span class="p">()</span>
            <span class="n">shape</span><span class="o">.</span><span class="n">_propogate_scene_tree</span><span class="p">()</span>

        <span class="n">d</span> <span class="o">=</span> <span class="mi">10000</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
            <span class="n">td</span><span class="p">,</span> <span class="n">tp1</span><span class="p">,</span> <span class="n">tp2</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">closest_point</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">inf_dist</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">td</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">td</span> <span class="o">&lt;</span> <span class="n">d</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">td</span>
                <span class="n">p1</span> <span class="o">=</span> <span class="n">tp1</span>
                <span class="n">p2</span> <span class="o">=</span> <span class="n">tp2</span>

        <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">10000</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">d</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span></div>

<div class="viewcode-block" id="Robot.iscollided"><a class="viewcode-back" href="../../../arm_superclass.html#roboticstoolbox.robot.Robot.Robot.iscollided">[docs]</a>    <span class="k">def</span> <span class="nf">iscollided</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="n">Shape</span><span class="p">,</span> <span class="n">skip</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the robot is in collision with a shape</span>

<span class="sd">        ``iscollided(shape)`` checks if this robot and shape have collided</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        shape</span>
<span class="sd">            The shape to compare distance to</span>
<span class="sd">        skip</span>
<span class="sd">            Skip setting all shape transforms based on q, use this</span>
<span class="sd">            option if using this method in conjuction with Swift to save time</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        iscollided</span>
<span class="sd">            True if shapes have collided</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_link_tf</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_propogate_scene_tree</span><span class="p">()</span>
            <span class="n">shape</span><span class="o">.</span><span class="n">_propogate_scene_tree</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">iscollided</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rtb</span><span class="o">.</span><span class="n">Robot</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">gripper</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grippers</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">gripper</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">iscollided</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                        <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Robot.collided"><a class="viewcode-back" href="../../../arm_superclass.html#roboticstoolbox.robot.Robot.Robot.collided">[docs]</a>    <span class="k">def</span> <span class="nf">collided</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="n">Shape</span><span class="p">,</span> <span class="n">skip</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the robot is in collision with a shape</span>

<span class="sd">        ``collided(shape)`` checks if this robot and shape have collided</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        shape</span>
<span class="sd">            The shape to compare distance to</span>
<span class="sd">        skip</span>
<span class="sd">            Skip setting all shape transforms based on q, use this</span>
<span class="sd">            option if using this method in conjuction with Swift to save time</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        collided</span>
<span class="sd">            True if shapes have collided</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;method collided is deprecated, use iscollided instead&quot;</span><span class="p">,</span> <span class="ne">FutureWarning</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">iscollided</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="n">skip</span><span class="p">)</span></div>

    <span class="c1"># --------------------------------------------------------------------- #</span>
    <span class="c1"># --------- Constraint Methods ---------------------------------------- #</span>
    <span class="c1"># --------------------------------------------------------------------- #</span>

<div class="viewcode-block" id="Robot.joint_velocity_damper"><a class="viewcode-back" href="../../../arm_superclass.html#roboticstoolbox.robot.Robot.Robot.joint_velocity_damper">[docs]</a>    <span class="k">def</span> <span class="nf">joint_velocity_damper</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
        <span class="n">pi</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">n</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">gain</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the joint velocity damper for QP motion control</span>

<span class="sd">        Formulates an inequality contraint which, when optimised for will</span>
<span class="sd">        make it impossible for the robot to run into joint limits. Requires</span>
<span class="sd">        the joint limits of the robot to be specified. See examples/mmc.py</span>
<span class="sd">        for use case</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        ps</span>
<span class="sd">            The minimum angle (in radians) in which the joint is</span>
<span class="sd">            allowed to approach to its limit</span>
<span class="sd">        pi</span>
<span class="sd">            The influence angle (in radians) in which the velocity</span>
<span class="sd">            damper becomes active</span>
<span class="sd">        n</span>
<span class="sd">            The number of joints to consider. Defaults to all joints</span>
<span class="sd">        gain</span>
<span class="sd">            The gain for the velocity damper</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Ain</span>
<span class="sd">            A (6,) vector inequality contraint for an optisator</span>
<span class="sd">        Bin</span>
<span class="sd">            b (6,) vector inequality contraint for an optisator</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span>

        <span class="n">Ain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
        <span class="n">Bin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">qlim</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">pi</span><span class="p">:</span>
                <span class="n">Bin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">gain</span> <span class="o">*</span> <span class="p">(((</span><span class="bp">self</span><span class="o">.</span><span class="n">qlim</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="n">ps</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">pi</span> <span class="o">-</span> <span class="n">ps</span><span class="p">))</span>
                <span class="n">Ain</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qlim</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">pi</span><span class="p">:</span>
                <span class="n">Bin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">*</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">qlim</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="n">ps</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">pi</span> <span class="o">-</span> <span class="n">ps</span><span class="p">)</span>
                <span class="n">Ain</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">Ain</span><span class="p">,</span> <span class="n">Bin</span></div>

<div class="viewcode-block" id="Robot.link_collision_damper"><a class="viewcode-back" href="../../../arm_superclass.html#roboticstoolbox.robot.Robot.Robot.link_collision_damper">[docs]</a>    <span class="k">def</span> <span class="nf">link_collision_damper</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">shape</span><span class="p">:</span> <span class="n">CollisionShape</span><span class="p">,</span>
        <span class="n">q</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
        <span class="n">di</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span>
        <span class="n">ds</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
        <span class="n">xi</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">end</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Link</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Link</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">collision_list</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Shape</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute a collision constrain for QP motion control</span>

<span class="sd">        Formulates an inequality contraint which, when optimised for will</span>
<span class="sd">        make it impossible for the robot to run into a collision. Requires</span>
<span class="sd">        See examples/neo.py for use case</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        ds</span>
<span class="sd">            The minimum distance in which a joint is allowed to</span>
<span class="sd">            approach the collision object shape</span>
<span class="sd">        di</span>
<span class="sd">            The influence distance in which the velocity</span>
<span class="sd">            damper becomes active</span>
<span class="sd">        xi</span>
<span class="sd">            The gain for the velocity damper</span>
<span class="sd">        end</span>
<span class="sd">            The end link of the robot to consider</span>
<span class="sd">        start</span>
<span class="sd">            The start link of the robot to consider</span>
<span class="sd">        collision_list</span>
<span class="sd">            A list of shapes to consider for collision</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Ain</span>
<span class="sd">            A (6,) vector inequality contraint for an optisator</span>
<span class="sd">        Bin</span>
<span class="sd">            b (6,) vector inequality contraint for an optisator</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">end</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_limit_links</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">)</span>

        <span class="n">links</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">)</span>

        <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">Ain</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">bin</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">def</span> <span class="nf">indiv_calculation</span><span class="p">(</span><span class="n">link</span><span class="p">:</span> <span class="n">Link</span><span class="p">,</span> <span class="n">link_col</span><span class="p">:</span> <span class="n">CollisionShape</span><span class="p">,</span> <span class="n">q</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">):</span>
            <span class="n">d</span><span class="p">,</span> <span class="n">wTlp</span><span class="p">,</span> <span class="n">wTcp</span> <span class="o">=</span> <span class="n">link_col</span><span class="o">.</span><span class="n">closest_point</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">di</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">wTlp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">wTcp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lpTcp</span> <span class="o">=</span> <span class="o">-</span><span class="n">wTlp</span> <span class="o">+</span> <span class="n">wTcp</span>

                <span class="n">norm</span> <span class="o">=</span> <span class="n">lpTcp</span> <span class="o">/</span> <span class="n">d</span>
                <span class="n">norm_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">norm</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>  <span class="c1"># type: ignore</span>
                <span class="p">)</span>

                <span class="c1"># tool = (self.fkine(q, end=link).inv() * SE3(wTlp)).A[:3, 3]</span>

                <span class="c1"># Je = self.jacob0(q, end=link, tool=tool)</span>
                <span class="c1"># Je[:3, :] = self._T[:3, :3] @ Je[:3, :]</span>

                <span class="c1"># n_dim = Je.shape[1]</span>
                <span class="c1"># dp = norm_h @ shape.v</span>
                <span class="c1"># l_Ain = zeros((1, self.n))</span>

                <span class="n">Je</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jacobe</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">link</span><span class="p">,</span> <span class="n">tool</span><span class="o">=</span><span class="n">link_col</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                <span class="n">n_dim</span> <span class="o">=</span> <span class="n">Je</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">dp</span> <span class="o">=</span> <span class="n">norm_h</span> <span class="o">@</span> <span class="n">shape</span><span class="o">.</span><span class="n">v</span>
                <span class="n">l_Ain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>

                <span class="n">l_Ain</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="n">n_dim</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">norm_h</span> <span class="o">@</span> <span class="n">Je</span>
                <span class="n">l_bin</span> <span class="o">=</span> <span class="p">(</span><span class="n">xi</span> <span class="o">*</span> <span class="p">(</span><span class="n">d</span> <span class="o">-</span> <span class="n">ds</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">di</span> <span class="o">-</span> <span class="n">ds</span><span class="p">))</span> <span class="o">+</span> <span class="n">dp</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma nocover</span>
                <span class="n">l_Ain</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">l_bin</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">return</span> <span class="n">l_Ain</span><span class="p">,</span> <span class="n">l_bin</span>

        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">isjoint</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">collision_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">col_list</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">collision</span>

                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">col_list</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">col_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">collision_list</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span>  <span class="c1"># pragma nocover</span>

            <span class="k">for</span> <span class="n">link_col</span> <span class="ow">in</span> <span class="n">col_list</span><span class="p">:</span>
                <span class="n">l_Ain</span><span class="p">,</span> <span class="n">l_bin</span> <span class="o">=</span> <span class="n">indiv_calculation</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">link_col</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

                <span class="k">if</span> <span class="n">l_Ain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">l_bin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">Ain</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">Ain</span> <span class="o">=</span> <span class="n">l_Ain</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">Ain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Ain</span><span class="p">,</span> <span class="n">l_Ain</span><span class="p">))</span>

                    <span class="k">if</span> <span class="nb">bin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="nb">bin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">l_bin</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">bin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="nb">bin</span><span class="p">,</span> <span class="n">l_bin</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">Ain</span><span class="p">,</span> <span class="nb">bin</span></div>

<div class="viewcode-block" id="Robot.vision_collision_damper"><a class="viewcode-back" href="../../../arm_superclass.html#roboticstoolbox.robot.Robot.Robot.vision_collision_damper">[docs]</a>    <span class="k">def</span> <span class="nf">vision_collision_damper</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">shape</span><span class="p">:</span> <span class="n">CollisionShape</span><span class="p">,</span>
        <span class="n">camera</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;Robot&quot;</span><span class="p">,</span> <span class="n">SE3</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">camera_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">q</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">di</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
        <span class="n">ds</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
        <span class="n">xi</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">collision_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># pragma nocover</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute a vision collision constrain for QP motion control</span>

<span class="sd">        Formulates an inequality contraint which, when optimised for will</span>
<span class="sd">        make it impossible for the robot to run into a line of sight.</span>
<span class="sd">        See examples/fetch_vision.py for use case</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        camera</span>
<span class="sd">            The camera link, either as a robotic link or SE3</span>
<span class="sd">            pose</span>
<span class="sd">        camera_n</span>
<span class="sd">            Degrees of freedom of the camera link</span>
<span class="sd">        ds</span>
<span class="sd">            The minimum distance in which a joint is allowed to</span>
<span class="sd">            approach the collision object shape</span>
<span class="sd">        di</span>
<span class="sd">            The influence distance in which the velocity</span>
<span class="sd">            damper becomes active</span>
<span class="sd">        xi</span>
<span class="sd">            The gain for the velocity damper</span>
<span class="sd">        end</span>
<span class="sd">            The end link of the robot to consider</span>
<span class="sd">        start</span>
<span class="sd">            The start link of the robot to consider</span>
<span class="sd">        collision_list</span>
<span class="sd">            A list of shapes to consider for collision</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Ain</span>
<span class="sd">            A (6,) vector inequality contraint for an optisator</span>
<span class="sd">        Bin</span>
<span class="sd">            b (6,) vector inequality contraint for an optisator</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">end</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_limit_links</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">)</span>

        <span class="n">links</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">)</span>

        <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">Ain</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">bin</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">def</span> <span class="nf">rotation_between_vectors</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">b</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

            <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">SE3</span><span class="o">.</span><span class="n">AngleAxis</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">camera</span><span class="p">,</span> <span class="n">rtb</span><span class="o">.</span><span class="n">BaseRobot</span><span class="p">):</span>
            <span class="n">wTcp</span> <span class="o">=</span> <span class="n">camera</span><span class="o">.</span><span class="n">fkine</span><span class="p">(</span><span class="n">camera</span><span class="o">.</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">A</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">camera</span><span class="p">,</span> <span class="n">SE3</span><span class="p">):</span>
            <span class="n">wTcp</span> <span class="o">=</span> <span class="n">camera</span><span class="o">.</span><span class="n">t</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Camera must be a robotic link or SE3 pose&quot;</span><span class="p">)</span>

        <span class="n">wTtp</span> <span class="o">=</span> <span class="n">shape</span><span class="o">.</span><span class="n">T</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Create line of sight object</span>
        <span class="n">los_mid</span> <span class="o">=</span> <span class="n">SE3</span><span class="p">((</span><span class="n">wTcp</span> <span class="o">+</span> <span class="n">wTtp</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">los_orientation</span> <span class="o">=</span> <span class="n">rotation_between_vectors</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span> <span class="n">wTcp</span> <span class="o">-</span> <span class="n">wTtp</span>  <span class="c1"># type: ignore</span>
        <span class="p">)</span>

        <span class="n">los</span> <span class="o">=</span> <span class="n">Cylinder</span><span class="p">(</span>
            <span class="n">radius</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
            <span class="n">length</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">wTcp</span> <span class="o">-</span> <span class="n">wTtp</span><span class="p">),</span>  <span class="c1"># type: ignore</span>
            <span class="n">base</span><span class="o">=</span><span class="p">(</span><span class="n">los_mid</span> <span class="o">*</span> <span class="n">los_orientation</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">def</span> <span class="nf">indiv_calculation</span><span class="p">(</span><span class="n">link</span><span class="p">:</span> <span class="n">Link</span><span class="p">,</span> <span class="n">link_col</span><span class="p">:</span> <span class="n">CollisionShape</span><span class="p">,</span> <span class="n">q</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">):</span>
            <span class="n">d</span><span class="p">,</span> <span class="n">wTlp</span><span class="p">,</span> <span class="n">wTvp</span> <span class="o">=</span> <span class="n">link_col</span><span class="o">.</span><span class="n">closest_point</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">di</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">wTlp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">wTvp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lpTvp</span> <span class="o">=</span> <span class="o">-</span><span class="n">wTlp</span> <span class="o">+</span> <span class="n">wTvp</span>

                <span class="n">norm</span> <span class="o">=</span> <span class="n">lpTvp</span> <span class="o">/</span> <span class="n">d</span>
                <span class="n">norm_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">norm</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
                <span class="p">)</span>  <span class="c1"># type: ignore</span>

                <span class="n">tool</span> <span class="o">=</span> <span class="n">SE3</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fkine</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">link</span><span class="p">)</span><span class="o">.</span><span class="n">A</span><span class="p">)</span> <span class="o">@</span> <span class="n">SE3</span><span class="p">(</span><span class="n">wTlp</span><span class="p">)</span><span class="o">.</span><span class="n">A</span><span class="p">)[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
                <span class="p">)</span>

                <span class="n">Je</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jacob0</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">link</span><span class="p">,</span> <span class="n">tool</span><span class="o">=</span><span class="n">tool</span><span class="o">.</span><span class="n">A</span><span class="p">)</span>
                <span class="n">Je</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_T</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">@</span> <span class="n">Je</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">n_dim</span> <span class="o">=</span> <span class="n">Je</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">camera</span><span class="p">,</span> <span class="s2">&quot;Robot&quot;</span><span class="p">):</span>
                    <span class="n">Jv</span> <span class="o">=</span> <span class="n">camera</span><span class="o">.</span><span class="n">jacob0</span><span class="p">(</span><span class="n">camera</span><span class="o">.</span><span class="n">q</span><span class="p">)</span>
                    <span class="n">Jv</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_T</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">@</span> <span class="n">Jv</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span>

                    <span class="n">Jv</span> <span class="o">*=</span> <span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">wTvp</span> <span class="o">-</span> <span class="n">shape</span><span class="o">.</span><span class="n">T</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">los</span><span class="o">.</span><span class="n">length</span>
                    <span class="p">)</span>  <span class="c1"># type: ignore</span>

                    <span class="n">dpc</span> <span class="o">=</span> <span class="n">norm_h</span> <span class="o">@</span> <span class="n">Jv</span>
                    <span class="n">dpc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="n">dpc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="n">camera_n</span><span class="p">],</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">-</span> <span class="p">(</span><span class="n">camera</span><span class="o">.</span><span class="n">n</span> <span class="o">-</span> <span class="n">camera_n</span><span class="p">)),</span>
                            <span class="n">dpc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">camera_n</span><span class="p">:],</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dpc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="n">camera_n</span><span class="p">))</span>

                <span class="n">dpt</span> <span class="o">=</span> <span class="n">norm_h</span> <span class="o">@</span> <span class="n">shape</span><span class="o">.</span><span class="n">v</span>
                <span class="n">dpt</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">wTvp</span> <span class="o">-</span> <span class="n">wTcp</span><span class="p">)</span> <span class="o">/</span> <span class="n">los</span><span class="o">.</span><span class="n">length</span>  <span class="c1"># type: ignore</span>

                <span class="n">l_Ain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="n">camera_n</span><span class="p">))</span>
                <span class="n">l_Ain</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="n">n_dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm_h</span> <span class="o">@</span> <span class="n">Je</span>
                <span class="n">l_Ain</span> <span class="o">-=</span> <span class="n">dpc</span>
                <span class="n">l_bin</span> <span class="o">=</span> <span class="p">(</span><span class="n">xi</span> <span class="o">*</span> <span class="p">(</span><span class="n">d</span> <span class="o">-</span> <span class="n">ds</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">di</span> <span class="o">-</span> <span class="n">ds</span><span class="p">))</span> <span class="o">+</span> <span class="n">dpt</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">l_Ain</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">l_bin</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">return</span> <span class="n">l_Ain</span><span class="p">,</span> <span class="n">l_bin</span>

        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">isjoint</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">collision_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">col_list</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">collision</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">col_list</span> <span class="o">=</span> <span class="n">collision_list</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">link_col</span> <span class="ow">in</span> <span class="n">col_list</span><span class="p">:</span>
                <span class="n">l_Ain</span><span class="p">,</span> <span class="n">l_bin</span> <span class="o">=</span> <span class="n">indiv_calculation</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">link_col</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">l_Ain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">l_bin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">Ain</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">Ain</span> <span class="o">=</span> <span class="n">l_Ain</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">Ain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Ain</span><span class="p">,</span> <span class="n">l_Ain</span><span class="p">))</span>

                    <span class="k">if</span> <span class="nb">bin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="nb">bin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">l_bin</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">bin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="nb">bin</span><span class="p">,</span> <span class="n">l_bin</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">Ain</span><span class="p">,</span> <span class="nb">bin</span></div>

    <span class="c1"># --------------------------------------------------------------------- #</span>
    <span class="c1"># --------- Dynamics Methods ------------------------------------------ #</span>
    <span class="c1"># --------------------------------------------------------------------- #</span>

<div class="viewcode-block" id="Robot.rne"><a class="viewcode-back" href="../../../arm_superclass.html#roboticstoolbox.robot.Robot.Robot.rne">[docs]</a>    <span class="k">def</span> <span class="nf">rne</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">q</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span>
        <span class="n">qd</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span>
        <span class="n">qdd</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span>
        <span class="n">symbolic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">gravity</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ArrayLike</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute inverse dynamics via recursive Newton-Euler formulation</span>

<span class="sd">        ``rne_dh(q, qd, qdd)`` where the arguments have shape (n,) where n is</span>
<span class="sd">        the number of robot joints.  The result has shape (n,).</span>

<span class="sd">        ``rne_dh(q, qd, qdd)`` where the arguments have shape (m,n) where n</span>
<span class="sd">        is the number of robot joints and where m is the number of steps in</span>
<span class="sd">        the joint trajectory.  The result has shape (m,n).</span>

<span class="sd">        ``rne_dh(p)`` where the input is a 1D array ``p`` = [q, qd, qdd] with</span>
<span class="sd">        shape (3n,), and the result has shape (n,).</span>

<span class="sd">        ``rne_dh(p)`` where the input is a 2D array ``p`` = [q, qd, qdd] with</span>
<span class="sd">        shape (m,3n) and the result has shape (m,n).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        q</span>
<span class="sd">            Joint coordinates</span>
<span class="sd">        qd</span>
<span class="sd">            Joint velocity</span>
<span class="sd">        qdd</span>
<span class="sd">            Joint acceleration</span>
<span class="sd">        symbolic</span>
<span class="sd">            If True, supports symbolic expressions</span>
<span class="sd">        gravity</span>
<span class="sd">            Gravitational acceleration, defaults to attribute</span>
<span class="sd">            of self</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tau</span>
<span class="sd">            Joint force/torques</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - This version supports symbolic model parameters</span>
<span class="sd">        - Verified against MATLAB code</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span>

        <span class="c1"># allocate intermediate variables</span>
        <span class="n">Xup</span> <span class="o">=</span> <span class="n">SE3</span><span class="o">.</span><span class="n">Alloc</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">Xtree</span> <span class="o">=</span> <span class="n">SE3</span><span class="o">.</span><span class="n">Alloc</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="n">v</span> <span class="o">=</span> <span class="n">SpatialVelocity</span><span class="o">.</span><span class="n">Alloc</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">SpatialAcceleration</span><span class="o">.</span><span class="n">Alloc</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">SpatialForce</span><span class="o">.</span><span class="n">Alloc</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">SpatialInertia</span><span class="o">.</span><span class="n">Alloc</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>  <span class="c1"># noqa</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># joint motion subspace</span>

        <span class="c1"># Handle trajectory case</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">getmatrix</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="n">qd</span> <span class="o">=</span> <span class="n">getmatrix</span><span class="p">(</span><span class="n">qd</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="n">qdd</span> <span class="o">=</span> <span class="n">getmatrix</span><span class="p">(</span><span class="n">qdd</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="n">l</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">shape</span>  <span class="c1"># type: ignore</span>

        <span class="k">if</span> <span class="n">symbolic</span><span class="p">:</span>  <span class="c1"># pragma: nocover</span>
            <span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;O&quot;</span><span class="p">)</span>  <span class="c1"># joint torque/force</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>  <span class="c1"># joint torque/force</span>

        <span class="c1"># TODO Should the dynamic parameters of static links preceding joint be</span>
        <span class="c1"># somehow merged with the joint?</span>

        <span class="c1"># A temp variable to handle static joints</span>
        <span class="n">Ts</span> <span class="o">=</span> <span class="n">SE3</span><span class="p">()</span>

        <span class="c1"># A counter through joints</span>
        <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
            <span class="n">qk</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">qdk</span> <span class="o">=</span> <span class="n">qd</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">qddk</span> <span class="o">=</span> <span class="n">qdd</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span>

            <span class="c1"># initialize intermediate variables</span>
            <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">isjoint</span><span class="p">:</span>
                    <span class="n">I</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">SpatialInertia</span><span class="p">(</span><span class="n">m</span><span class="o">=</span><span class="n">link</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">link</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">symbolic</span> <span class="ow">and</span> <span class="n">link</span><span class="o">.</span><span class="n">Ts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: nocover</span>
                        <span class="n">Xtree</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">SE3</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;O&quot;</span><span class="p">),</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">link</span><span class="o">.</span><span class="n">Ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">Xtree</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ts</span> <span class="o">*</span> <span class="n">SE3</span><span class="p">(</span><span class="n">link</span><span class="o">.</span><span class="n">Ts</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">link</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>

                    <span class="c1"># Increment the joint counter</span>
                    <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="c1"># Reset the Ts tracker</span>
                    <span class="n">Ts</span> <span class="o">=</span> <span class="n">SE3</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma nocover</span>
                    <span class="c1"># TODO Keep track of inertia and transform???</span>
                    <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">Ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">Ts</span> <span class="o">*=</span> <span class="n">SE3</span><span class="p">(</span><span class="n">link</span><span class="o">.</span><span class="n">Ts</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">gravity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">a_grav</span> <span class="o">=</span> <span class="o">-</span><span class="n">SpatialAcceleration</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gravity</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma nocover</span>
                <span class="n">a_grav</span> <span class="o">=</span> <span class="o">-</span><span class="n">SpatialAcceleration</span><span class="p">(</span><span class="n">gravity</span><span class="p">)</span>

            <span class="c1"># forward recursion</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                <span class="n">vJ</span> <span class="o">=</span> <span class="n">SpatialVelocity</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">qdk</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

                <span class="c1"># transform from parent(j) to j</span>
                <span class="n">Xup</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">SE3</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">A</span><span class="p">(</span><span class="n">qk</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span><span class="o">.</span><span class="n">inv</span><span class="p">()</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">v</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">vJ</span>
                    <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xup</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">a_grav</span> <span class="o">+</span> <span class="n">SpatialAcceleration</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">qddk</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">jp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">jindex</span>  <span class="c1"># type: ignore</span>
                    <span class="n">v</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xup</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="n">jp</span><span class="p">]</span> <span class="o">+</span> <span class="n">vJ</span>
                    <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">Xup</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">a</span><span class="p">[</span><span class="n">jp</span><span class="p">]</span> <span class="o">+</span> <span class="n">SpatialAcceleration</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">qddk</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">+</span> <span class="n">v</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">@</span> <span class="n">vJ</span>
                    <span class="p">)</span>

                <span class="n">f</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">I</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">@</span> <span class="p">(</span><span class="n">I</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

            <span class="c1"># backward recursion</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">)):</span>
                <span class="c1"># next line could be dot(), but fails for symbolic arguments</span>
                <span class="n">Q</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">A</span> <span class="o">*</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">jp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">jindex</span>  <span class="c1"># type: ignore</span>
                    <span class="n">f</span><span class="p">[</span><span class="n">jp</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">jp</span><span class="p">]</span> <span class="o">+</span> <span class="n">Xup</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">f</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma nocover</span>
            <span class="k">return</span> <span class="n">Q</span></div></div>


<span class="c1"># ============================================================================= #</span>
<span class="c1"># ================= Robot2 Class ============================================== #</span>
<span class="c1"># ============================================================================= #</span>


<div class="viewcode-block" id="Robot2"><a class="viewcode-back" href="../../../arm_superclass.html#roboticstoolbox.robot.Robot.Robot2">[docs]</a><span class="k">class</span> <span class="nc">Robot2</span><span class="p">(</span><span class="n">BaseRobot</span><span class="p">[</span><span class="n">Link2</span><span class="p">]):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">ETS2</span><span class="p">):</span>
            <span class="c1"># we&#39;re passed an ETS string</span>
            <span class="n">links</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># chop it up into segments, a link frame after every joint</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ets_j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">split</span><span class="p">()):</span>
                <span class="n">elink</span> <span class="o">=</span> <span class="n">Link2</span><span class="p">(</span><span class="n">ETS2</span><span class="p">(</span><span class="n">ets_j</span><span class="p">),</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;link</span><span class="si">{</span><span class="n">j</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">parent</span> <span class="o">=</span> <span class="n">elink</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">elink</span><span class="o">.</span><span class="n">qlim</span> <span class="ow">is</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="n">elink</span><span class="o">.</span><span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="n">elink</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">qlim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="p">):</span>  <span class="c1"># pragma nocover</span>
                    <span class="n">elink</span><span class="o">.</span><span class="n">qlim</span> <span class="o">=</span> <span class="n">elink</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">qlim</span>
                <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elink</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">smb</span><span class="o">.</span><span class="n">islistof</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Link2</span><span class="p">):</span>
            <span class="n">links</span> <span class="o">=</span> <span class="n">arg</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma nocover</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;constructor argument must be ETS2 or list of Link2&quot;</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Should just set it to None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">SE2</span><span class="p">()</span>  <span class="c1"># override superclass</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">base</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SE2</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get/set robot base transform (Robot superclass)</span>

<span class="sd">        ``robot.base`` is the robot base transform</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        base</span>
<span class="sd">            robot tool transform</span>

<span class="sd">        - ``robot.base = ...`` checks and sets the robot base transform</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - The private attribute ``_base`` will be None in the case of</span>
<span class="sd">            no base transform, but this property will return ``SE3()`` which</span>
<span class="sd">            is an identity matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma nocover</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_base</span> <span class="o">=</span> <span class="n">SE2</span><span class="p">()</span>

        <span class="c1"># return a copy, otherwise somebody with</span>
        <span class="c1"># reference to the base can change it</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="nd">@base</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">base</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">SE2</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_base</span> <span class="o">=</span> <span class="n">T</span>
        <span class="k">elif</span> <span class="n">SE2</span><span class="o">.</span><span class="n">isvalid</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>  <span class="c1"># pragma nocover</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tool</span> <span class="o">=</span> <span class="n">SE2</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="Robot2.jacob0"><a class="viewcode-back" href="../../../arm_superclass.html#roboticstoolbox.robot.Robot.Robot2.jacob0">[docs]</a>    <span class="k">def</span> <span class="nf">jacob0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ets</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span><span class="o">.</span><span class="n">jacob0</span><span class="p">(</span><span class="n">q</span><span class="p">)</span></div>

<div class="viewcode-block" id="Robot2.jacobe"><a class="viewcode-back" href="../../../arm_superclass.html#roboticstoolbox.robot.Robot.Robot2.jacobe">[docs]</a>    <span class="k">def</span> <span class="nf">jacobe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ets</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span><span class="o">.</span><span class="n">jacobe</span><span class="p">(</span><span class="n">q</span><span class="p">)</span></div>

<div class="viewcode-block" id="Robot2.fkine"><a class="viewcode-back" href="../../../arm_superclass.html#roboticstoolbox.robot.Robot.Robot2.fkine">[docs]</a>    <span class="k">def</span> <span class="nf">fkine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ets</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span><span class="o">.</span><span class="n">fkine</span><span class="p">(</span><span class="n">q</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">reach</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reach of the robot</span>

<span class="sd">        A conservative estimate of the reach of the robot. It is computed as</span>
<span class="sd">        the sum of the translational ETs that define the link transform.</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        Computed on the first access. If kinematic parameters</span>
<span class="sd">        subsequently change this will not be reflected.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        reach</span>
<span class="sd">            Maximum reach of the robot</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - Probably an overestimate of reach</span>
<span class="sd">        - Used by numerical inverse kinematics to scale translational</span>
<span class="sd">          error.</span>
<span class="sd">        - For a prismatic joint, uses ``qlim`` if it is set</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># TODO</span>
        <span class="c1"># This should be a start, end method and compute the reach based on the</span>
        <span class="c1"># given ets. Then use an lru_cache to speed up return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reach</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">d_all</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ee_links</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">et</span> <span class="ow">in</span> <span class="n">link</span><span class="o">.</span><span class="n">ets</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">et</span><span class="o">.</span><span class="n">istranslation</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">et</span><span class="o">.</span><span class="n">isjoint</span><span class="p">:</span>
                                <span class="c1"># the length of a prismatic joint depends on the</span>
                                <span class="c1"># joint limits.  They might be set in the ET</span>
                                <span class="c1"># or in the Link depending on how the robot</span>
                                <span class="c1"># was constructed</span>
                                <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">qlim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">d</span> <span class="o">+=</span> <span class="nb">max</span><span class="p">(</span><span class="n">link</span><span class="o">.</span><span class="n">qlim</span><span class="p">)</span>
                                <span class="k">elif</span> <span class="n">et</span><span class="o">.</span><span class="n">qlim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma nocover</span>
                                    <span class="n">d</span> <span class="o">+=</span> <span class="nb">max</span><span class="p">(</span><span class="n">et</span><span class="o">.</span><span class="n">qlim</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">d</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">et</span><span class="o">.</span><span class="n">eta</span><span class="p">)</span>
                    <span class="n">link</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">parent</span>
                    <span class="k">if</span> <span class="n">link</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">d_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                        <span class="k">break</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_reach</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">d_all</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reach</span>

<div class="viewcode-block" id="Robot2.fkine_all"><a class="viewcode-back" href="../../../arm_superclass.html#roboticstoolbox.robot.Robot.Robot2.fkine_all">[docs]</a>    <span class="k">def</span> <span class="nf">fkine_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SE2</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the pose of every link frame</span>

<span class="sd">        ``T = robot.fkine_all(q)`` is  an SE3 instance with ``robot.nlinks +</span>
<span class="sd">        1`` values:</span>

<span class="sd">        - ``T[0]`` is the base transform</span>
<span class="sd">        - ``T[i]`` is the pose of link whose ``number`` is ``i``</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        q</span>
<span class="sd">            The joint configuration</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fkine_all</span>
<span class="sd">            Pose of all links</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        - J. Haviland, and P. Corke. &quot;Manipulator Differential Kinematics Part I:</span>
<span class="sd">          Kinematics, Velocity, and Applications.&quot; arXiv preprint arXiv:2207.01796 (2022).</span>

<span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa</span>

        <span class="n">q</span> <span class="o">=</span> <span class="n">getvector</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>

        <span class="n">Tbase</span> <span class="o">=</span> <span class="n">SE2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">)</span>  <span class="c1"># add base, also sets the type</span>

        <span class="n">linkframes</span> <span class="o">=</span> <span class="n">Tbase</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">Alloc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nlinks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">linkframes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Tbase</span>

        <span class="k">def</span> <span class="nf">recurse</span><span class="p">(</span><span class="n">Tall</span><span class="p">,</span> <span class="n">Tparent</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">link</span><span class="p">):</span>
            <span class="c1"># if joint??</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">Tparent</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">T</span> <span class="o">*=</span> <span class="n">SE2</span><span class="p">(</span><span class="n">link</span><span class="o">.</span><span class="n">A</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">link</span><span class="o">.</span><span class="n">jindex</span><span class="p">]))</span>

                <span class="n">Tall</span><span class="p">[</span><span class="n">link</span><span class="o">.</span><span class="n">number</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span>

                <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">nchildren</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># no children</span>
                    <span class="k">return</span>
                <span class="k">elif</span> <span class="n">link</span><span class="o">.</span><span class="n">nchildren</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># one child</span>
                    <span class="k">if</span> <span class="n">link</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ee_links</span><span class="p">:</span>  <span class="c1"># pragma nocover</span>
                        <span class="c1"># this link is an end-effector, go no further</span>
                        <span class="k">return</span>
                    <span class="n">link</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># multiple children</span>
                    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">link</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                        <span class="n">recurse</span><span class="p">(</span><span class="n">Tall</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span>
                    <span class="k">return</span>

        <span class="n">recurse</span><span class="p">(</span><span class="n">linkframes</span><span class="p">,</span> <span class="n">Tbase</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">linkframes</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Jesse Haviland and Peter Corke.
      <span class="lastupdated">Last updated on 15-May-2023.
      </span></p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-11Q6WJM565"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-11Q6WJM565', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>